<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centros de Formaci칩n Profesional - M치laga</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .filter-section select, .filter-section input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-section select:focus, .filter-section input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 15px;
        }

        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stats-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .reset-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
            margin-top: 15px;
        }

        .reset-btn:hover {
            background: #5568d3;
        }

        .info-window {
            max-width: 380px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .info-header {
            background: linear-gradient(135deg, #007849 0%, #00a651 100%);
            color: white;
            padding: 15px;
            margin: -10px -10px 15px -10px;
            border-radius: 8px 8px 0 0;
        }

        .info-header h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .info-location {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            opacity: 0.95;
        }

        .info-section {
            margin-bottom: 15px;
        }

        .info-section-title {
            color: #007849;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid #00a651;
        }

        .info-badge {
            display: inline-block;
            background: #f0f7f4;
            color: #007849;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
        }

        .ciclo-item {
            background: #ffffff;
            border-left: 3px solid #00a651;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .ciclo-item:last-child {
            margin-bottom: 0;
        }

        .ciclo-nombre {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .ciclo-detalles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .ciclo-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .ciclo-tag.ensenanza {
            background: #e3f2fd;
            color: #1565c0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            #map {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>游꿉 Centros de Formaci칩n Profesional en M치laga</h1>
            <p>Explora la oferta de FP en la provincia de M치laga</p>
        </div>

        <div id="error-container"></div>

        <div class="controls">
            <div class="stats">
                <div class="stats-number" id="total-centros">-</div>
                <div class="stats-label">Centros encontrados</div>
            </div>

            <div class="filter-grid">
                <div class="filter-section">
                    <label for="familia-filter">Familia Profesional:</label>
                    <select id="familia-filter">
                        <option value="">Todas las familias</option>
                    </select>
                </div>

                <div class="filter-section">
                    <label for="ensenanza-filter">Tipo de Ense침anza:</label>
                    <select id="ensenanza-filter">
                        <option value="">Todos los tipos</option>
                    </select>
                </div>

                <div class="filter-section">
                    <label for="localidad-filter">Localidad:</label>
                    <select id="localidad-filter">
                        <option value="">Todas las localidades</option>
                    </select>
                </div>

                <div class="filter-section">
                    <label for="search-filter">Buscar centro o ciclo:</label>
                    <input type="text" id="search-filter" placeholder="Escribe para buscar...">
                </div>
            </div>

            <button class="reset-btn" id="reset-btn">Limpiar filtros</button>
        </div>

        <div id="map"></div>
    </div>

    <script>
        // Configuraci칩n
        const API_KEY = 'AIzaSyANqujWU86Yfi_1vfhTKxc1hr3s6Hce0tA'; // IMPORTANTE: Reemplaza con tu API Key de Google Maps
        
        let map;
        let markers = [];
        let infoWindow;
        let allData = [];
        let mapLoaded = false;

        // Cargar los datos del CSV
        async function loadData() {
            try {
                const response = await window.fs.readFile('oferta_fp_geolocalizada_utf8.csv', { encoding: 'utf8' });
                
                // Parse CSV manualmente
                const lines = response.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                allData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = parseCSVLine(lines[i]);
                    if (values.length === headers.length) {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = values[index];
                        });
                        allData.push(obj);
                    }
                }
                
                console.log('Datos cargados:', allData.length, 'centros');
                return allData;
            } catch (error) {
                console.error('Error cargando datos:', error);
                showError('Error al cargar los datos del CSV');
                return [];
            }
        }

        // Parser simple de CSV que maneja comas dentro de comillas
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"(.*)"$/, '$1'));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim().replace(/^"(.*)"$/, '$1'));
            
            return result;
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">丘멆잺 ${message}</div>`;
        }

        // Inicializar Google Maps
        function initMap() {
            if (mapLoaded) return;
            
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 36.7213, lng: -4.4214 }, // Centro de M치laga
                    zoom: 10,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                });

                infoWindow = new google.maps.InfoWindow();
                mapLoaded = true;
                
                console.log('Mapa inicializado correctamente');
                
                // Cargar datos y mostrar marcadores
                loadData().then(data => {
                    if (data.length > 0) {
                        populateFilters(data);
                        displayMarkers(data);
                    }
                });
                
            } catch (error) {
                console.error('Error al inicializar el mapa:', error);
                showError('Error al inicializar el mapa: ' + error.message);
            }
        }

        // Poblar los filtros
        function populateFilters(data) {
            const familias = [...new Set(data.map(d => d['Familia Profesional']).filter(f => f))].sort();
            const ensenanzas = [...new Set(data.map(d => d['ENSE칌ANZA']).filter(e => e))].sort();
            const localidades = [...new Set(data.map(d => d['LOCALIDAD']).filter(l => l))].sort();

            const familiaSelect = document.getElementById('familia-filter');
            familias.forEach(familia => {
                const option = document.createElement('option');
                option.value = familia;
                option.textContent = familia;
                familiaSelect.appendChild(option);
            });

            const ensenanzaSelect = document.getElementById('ensenanza-filter');
            ensenanzas.forEach(ensenanza => {
                const option = document.createElement('option');
                option.value = ensenanza;
                option.textContent = ensenanza;
                ensenanzaSelect.appendChild(option);
            });

            const localidadSelect = document.getElementById('localidad-filter');
            localidades.forEach(localidad => {
                const option = document.createElement('option');
                option.value = localidad;
                option.textContent = localidad;
                localidadSelect.appendChild(option);
            });

            // A침adir event listeners
            familiaSelect.addEventListener('change', applyFilters);
            ensenanzaSelect.addEventListener('change', applyFilters);
            localidadSelect.addEventListener('change', applyFilters);
            document.getElementById('search-filter').addEventListener('input', applyFilters);
            document.getElementById('reset-btn').addEventListener('click', resetFilters);
        }

        // Mostrar marcadores
        function displayMarkers(data) {
            // Limpiar marcadores existentes
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Agrupar por centro para evitar marcadores duplicados
            const centrosMap = new Map();
            data.forEach(item => {
                const key = `${item['C칩digo']}_${item['latitud']}_${item['longitud']}`;
                if (!centrosMap.has(key)) {
                    centrosMap.set(key, {
                        centro: item['Centro'],
                        localidad: item['LOCALIDAD'],
                        codigo: item['C칩digo'],
                        lat: parseFloat(item['latitud']),
                        lng: parseFloat(item['longitud']),
                        ciclos: []
                    });
                }
                centrosMap.get(key).ciclos.push({
                    ciclo: item['Ciclo Formativo'],
                    familia: item['Familia Profesional'],
                    ensenanza: item['ENSE칌ANZA']
                });
            });

            // Crear marcadores
            centrosMap.forEach((centro, key) => {
                if (isNaN(centro.lat) || isNaN(centro.lng)) return;

                const marker = new google.maps.Marker({
                    position: { lat: centro.lat, lng: centro.lng },
                    map: map,
                    title: centro.centro
                });

                marker.addListener('click', () => {
                    const content = createInfoWindowContent(centro);
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });

                markers.push({ marker, data: centro, originalData: data.filter(d => d['C칩digo'] === centro.codigo) });
            });

            updateStats(centrosMap.size);
        }

        function createInfoWindowContent(centro) {
            let ciclosHtml = '<ul style="margin: 10px 0; padding-left: 20px;">';
            centro.ciclos.forEach(ciclo => {
                ciclosHtml += `<li style="margin: 5px 0;"><strong>${ciclo.ciclo}</strong><br>
                    <small style="color: #666;">${ciclo.familia} (${ciclo.ensenanza})</small></li>`;
            });
            ciclosHtml += '</ul>';

            return `
                <div class="info-window">
                    <h3>${centro.centro}</h3>
                    <p><strong>游늸 Localidad:</strong> ${centro.localidad}</p>
                    <p><strong>游댝 C칩digo:</strong> ${centro.codigo}</p>
                    <p><strong>游닄 Ciclos formativos (${centro.ciclos.length}):</strong></p>
                    ${ciclosHtml}
                </div>
            `;
        }

        function applyFilters() {
            const familiaFilter = document.getElementById('familia-filter').value.toLowerCase();
            const ensenanzaFilter = document.getElementById('ensenanza-filter').value.toLowerCase();
            const localidadFilter = document.getElementById('localidad-filter').value.toLowerCase();
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();

            let visibleCount = 0;

            markers.forEach(({ marker, originalData }) => {
                const shouldShow = originalData.some(item => {
                    const matchFamilia = !familiaFilter || item['Familia Profesional']?.toLowerCase() === familiaFilter;
                    const matchEnsenanza = !ensenanzaFilter || item['ENSE칌ANZA']?.toLowerCase() === ensenanzaFilter;
                    const matchLocalidad = !localidadFilter || item['LOCALIDAD']?.toLowerCase() === localidadFilter;
                    const matchSearch = !searchFilter || 
                        item['Centro']?.toLowerCase().includes(searchFilter) ||
                        item['Ciclo Formativo']?.toLowerCase().includes(searchFilter);
                    
                    return matchFamilia && matchEnsenanza && matchLocalidad && matchSearch;
                });

                marker.setVisible(shouldShow);
                if (shouldShow) visibleCount++;
            });

            updateStats(visibleCount);
        }

        function resetFilters() {
            document.getElementById('familia-filter').value = '';
            document.getElementById('ensenanza-filter').value = '';
            document.getElementById('localidad-filter').value = '';
            document.getElementById('search-filter').value = '';
            applyFilters();
        }

        function updateStats(count) {
            document.getElementById('total-centros').textContent = count;
        }

        // Cargar Google Maps API de forma din치mica
        function loadGoogleMapsAPI() {
            if (API_KEY === 'TU_API_KEY_AQUI') {
                showError('Por favor, configura tu API Key de Google Maps en el c칩digo (variable API_KEY).');
                return;
            }

            if (window.google && window.google.maps) {
                initMap();
                return;
            }

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                showError('Error al cargar Google Maps API. Verifica tu API Key y que la API est칠 habilitada.');
            };
            document.head.appendChild(script);
        }

        // Exponer initMap globalmente para el callback
        window.initMap = initMap;

        // Iniciar cuando el DOM est칠 listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGoogleMapsAPI);
        } else {
            loadGoogleMapsAPI();
        }
    </script>
</body>
</html>
